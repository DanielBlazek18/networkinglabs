input {
  tcp {
    port => 5044
    codec => json
  }
}

filter {
  mutate {
    gsub => [
      "message", "'", '"'
    ]
  }
  json {
    source => "message"
  }

  # Create a clone for 'Smash/forwardingGen/unifiedStatus/fec' message if delete is included
  if [update][delete] and [update][prefix] == "Smash/forwardingGen/unifiedStatus/fec" {
    clone {
      clones => ["fec_delete_event"]
      add_tag => ["cloned_for_delete"]
    }
  }

  # Handle 'Smash/forwardingGen/unifiedStatus/fec' update part of the message
  if ([update][prefix] == "Smash/forwardingGen/unifiedStatus/fec") and !("cloned_for_delete" in [tags]) {
    split {
      field => "[update][update]"
    }
    if !([update][update][path]) or !([update][update][path] =~ /\/via$/) {
      drop { }
    }
    if [update][update][val][0][intfId] and [update][update][val][0][intfId] != "" {
      split {
        field => "[update][update][val]"
      }
      mutate {
        add_field => {
          "event_type" => "fecId_update"
          "fecId" => "%{[update][update][path]}"
          "intfId" => "%{[update][update][val][intfId]}"
        }
      }
      if [update][update][val][hop] != "::" {
        mutate {
          add_field => {
            "next_hop" => "%{[update][update][val][hop]}"
          }
          convert => { "next_hop" => "string" }
        }
      }
    }
    mutate {
      gsub => [ "fecId", "/via$", "" ]
      convert => {
        "intfId" => "string"
        "fecId" => "string"
      }
    }
  }

  # Handle 'Smash/forwardingGen/unifiedStatus/fec' delete part of the message (from a clone)
  if "cloned_for_delete" in [tags] {
    split { field => "[update][delete]" }
    mutate {
      add_field => {
        "event_type" => "fecId_delete"
        "fecId" => "%{[update][delete][path]}"
      }
      convert => { "fecId" => "string" }
    }
    # mutate {
    #   remove_tag => ["cloned_for_delete", "fec_delete_event"]
    # }
  }

  # Handle 'eos_native:/Smash/routing/vrf/status' update messages
  if !([update][delete]) and ([update][prefix] =~ /^Smash\/routing\/vrf\/status\/NEO-\d+\/route$/) {
    split {
      field => "[update][update]"
    }
    if !([update][update][path]) or !([update][update][path] =~ /\/fecId$/) {
      drop { }
    }
    if [update][update][val][value] {
      mutate {
        add_field => {
          "event_type" => "prefix_update"
          "fecId" => "%{[update][update][val][value]}"
          "prefix" => "%{[update][update][path]}"
          #"telemetry_prefix" => "%{[update][prefix]}"
        }
      }
    }
    mutate {
      gsub => [ "prefix", "/fecId$", "" ]
      convert => {
        "prefix" => "string"
        "fecId" => "string"
        #"telemetry_prefix" => "string"
      }
    }
  }

  # Handle 'eos_native:/Smash/routing/vrf/status' delete messages
  if [update][delete] and ([update][prefix] =~ /^Smash\/routing\/vrf\/status\/NEO-\d+\/route$/) {
    split {
      field => "[update][delete]"
    }
    if [update][delete][path] {
      mutate {
        add_field => {
          "event_type" => "prefix_delete"
          "prefix" => "%{[update][delete][path]}"
          #"telemetry_prefix" => "%{[update][prefix]}"
        }
        convert => { 
          "prefix" => "string"
          #"telemetry_prefix" => "string"
        }
      }
    }
  }

  # Get VRF ID from the prefix
  grok {
    match => {
      "[update][prefix]" => "%{GREEDYDATA}/(?<vrf_name>NEO-\d+)/%{GREEDYDATA}"
    }
    tag_on_failure => []
  }

  mutate {
    remove_field => ["update"]
    remove_field => ["level", "@version", "path", "type", "host", "message", "logger_name", "tags", "taskName"]
  }
}

output {
  if ([event_type] == "prefix_update" or [event_type] == "prefix_delete") {
    elasticsearch {
      hosts => ["https://es01:9200"]
      index => "pygnmi-prefix"
      user => "elastic"
      password => "changeme"
      ssl => true
      ssl_certificate_verification => false
    }
  } else if ([event_type] == "fecId_update") {
    elasticsearch {
      hosts => ["https://es01:9200"]
      index => "pygnmi-fecid"
      user => "elastic"
      password => "changeme"
      ssl => true
      ssl_certificate_verification => false
    }
  } else if ([event_type] == "fecId_delete") {
    elasticsearch {
      hosts => ["https://es01:9200"]
      index => "pygnmi-fecid-del"
      user => "elastic"
      password => "changeme"
      ssl => true
      ssl_certificate_verification => false
    }
  } else {
    elasticsearch {
      hosts => ["https://es01:9200"]
      index => "pygnmi-other-%{+YYYY.MM.dd}"
      user => "elastic"
      password => "changeme"
      ssl => true
      ssl_certificate_verification => false
    }
  }
 stdout { codec => rubydebug }
}
